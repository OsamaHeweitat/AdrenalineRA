#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "virtualsfo.h"

unsigned char virtualsfo[] = {
        0x00, 0x50, 0x53, 0x46, 0x01, 0x01, 0x00, 0x00, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x00, 0x00, 
        0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x04, 0x02, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
        0x04, 0x00, 0x00, 0x00, 0x12, 0x00, 0x04, 0x02, 0x0a, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 
        0x08, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x04, 0x02, 0x05, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
        0x18, 0x00, 0x00, 0x00, 0x27, 0x00, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
        0x20, 0x00, 0x00, 0x00, 0x36, 0x00, 0x04, 0x02, 0x05, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
        0x24, 0x00, 0x00, 0x00, 0x45, 0x00, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
        0x2c, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x04, 0x02, 0x40, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
        0x30, 0x00, 0x00, 0x00, 0x42, 0x4f, 0x4f, 0x54, 0x41, 0x42, 0x4c, 0x45, 0x00, 0x43, 0x41, 0x54, 
        0x45, 0x47, 0x4f, 0x52, 0x59, 0x00, 0x44, 0x49, 0x53, 0x43, 0x5f, 0x49, 0x44, 0x00, 0x44, 0x49, 
        0x53, 0x43, 0x5f, 0x56, 0x45, 0x52, 0x53, 0x49, 0x4f, 0x4e, 0x00, 0x50, 0x41, 0x52, 0x45, 0x4e, 
        0x54, 0x41, 0x4c, 0x5f, 0x4c, 0x45, 0x56, 0x45, 0x4c, 0x00, 0x50, 0x53, 0x50, 0x5f, 0x53, 0x59, 
        0x53, 0x54, 0x45, 0x4d, 0x5f, 0x56, 0x45, 0x52, 0x00, 0x52, 0x45, 0x47, 0x49, 0x4f, 0x4e, 0x00, 
        0x54, 0x49, 0x54, 0x4c, 0x45, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x45, 0x47, 0x00, 0x00, 
        0x41, 0x44, 0x52, 0x4e, 0x30, 0x30, 0x30, 0x30, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x31, 0x2e, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x31, 0x2e, 0x30, 0x30, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 
        0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 
        0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 
        0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

struct sfo_header {
  uint32_t magic;
  uint32_t version;
  uint32_t key_table_offset;
  uint32_t data_table_offset;
  uint32_t entries_count;
} *sfo_header;

struct sfo_index_table_entry {
  uint16_t key_offset;
  uint16_t param_fmt;
  uint32_t param_len;
  uint32_t param_max_len;
  uint32_t data_offset;
} *sfo_entries;

unsigned int sfo_entries_size = 0;

struct sfo_table {
  unsigned int size;
  char *content;
} sfo_key_table, sfo_data_table;


void sfo_load_header(void* sfo) {
  sfo_header = sfo;
}

void sfo_load_entries(void* sfo) {
  sfo_entries_size = sizeof(struct sfo_index_table_entry) * sfo_header->entries_count;
  sfo_entries = (struct sfo_index_table_entry*)(sfo + sizeof(struct sfo_header));
}

void sfo_load_key_table(void *sfo) {
  sfo_key_table.size = sfo_header->data_table_offset - sfo_header->key_table_offset;
  sfo_key_table.content = sfo + sizeof(struct sfo_header) + sfo_entries_size;
}

void sfo_load_data_table(void* sfo) {

  if (sfo_header->entries_count) {
    sfo_data_table.size =
      (sfo_entries[sfo_header->entries_count - 1].data_offset +
      sfo_entries[sfo_header->entries_count - 1].param_max_len);
  } else {
    sfo_data_table.size = 0;
  }

  sfo_data_table.content = sfo + sizeof(struct sfo_header) + sfo_entries_size + sfo_key_table.size;
}

int sfo_get_index(char *key) {
  for (int i = 0; i < sfo_header->entries_count; i++) {
    if (strcmp(key, &sfo_key_table.content[sfo_entries[i].key_offset]) == 0) {
      return i;
    }
  }
  return -1;
}

int sfo_get_int_param(char *key)
{
  int index = sfo_get_index(key);
  uint32_t *integer;
  if (index < 0) { // Parameter not found
      return -1;
  }

  switch(sfo_entries[index].param_fmt)
  {
    case 516:
    case 1024:
      return 0;
    case 1028:
      integer = (uint32_t *) &sfo_data_table.content[sfo_entries[index].data_offset];
      return *integer;
  }
  return -1; // Parameter not found
}

char* sfo_get_string_param(char *key) {

  int index = sfo_get_index(key);
  if (index < 0) { // Parameter not found
      return NULL;
  }

  switch(sfo_entries[index].param_fmt)
  {
    case 516:
    case 1024:
      return &sfo_data_table.content[sfo_entries[index].data_offset];
    case 1028:
      return NULL;
  }

  return NULL;
}

void sfo_set_string_param(char *key, char *value) {
  int index = sfo_get_index(key);
  if (index < 0) { // Parameter not found
      return;
  }

  switch (sfo_entries[index].param_fmt) {
    case 516: // String
    case 1024: // Special mode string
      sfo_entries[index].param_len = strlen(value) + 1;
      int diff = sfo_entries[index].param_len - sfo_entries[index].param_max_len;
      if (diff > 0) {
        return; // error
      }

      // Overwrite old data with zeros
      memset(&sfo_data_table.content[sfo_entries[index].data_offset], 0,
        sfo_entries[index].param_max_len);

      // Save new string to data table
      snprintf(&sfo_data_table.content[sfo_entries[index].data_offset],
        sfo_entries[index].param_max_len, "%s", value);
      break;
    case 1028: // Integer
      break;
  }
}

void sfo_set_int_param(char *key, int value) {
  int index = sfo_get_index(key);
  if (index < 0) { // Parameter not found
      return;
  }

  switch (sfo_entries[index].param_fmt) {
    case 516: // String
    case 1024: // Special mode string
      break;
    case 1028: // Integer
      memcpy(&sfo_data_table.content[sfo_entries[index].data_offset], &value, 4);
      break;
  }
}

void sfo_parse(void* data) {
  sfo_load_header(data);
  sfo_load_entries(data);
  sfo_load_key_table(data);
  sfo_load_data_table(data);
}

void virtual_sfo_init()
{
  sfo_parse(virtualsfo);
}

int virtual_sfo_size()
{
  return sizeof(virtualsfo);
}

unsigned char* virtual_sfo_get()
{
  return virtualsfo;
}
